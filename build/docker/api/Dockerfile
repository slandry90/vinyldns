FROM hseeberger/scala-sbt:11.0.8_1.3.13_2.11.12 as builder

ARG BRANCH=r53-testing
ARG VINYLDNS_VERSION=steve-97

RUN git clone -b ${BRANCH} --single-branch --depth 1 https://github.com/slandry90/vinyldns.git /vinyldns

# The default jvmopts are huge, meant for running everything, use a paired down version
COPY .jvmopts /vinyldns

RUN cd /vinyldns ; sbt "set version in ThisBuild := \"${VINYLDNS_VERSION}\"" api/stage

FROM adoptopenjdk/openjdk11:jdk-11.0.8_10-alpine

RUN apk add --update --no-cache netcat-openbsd bash

COPY --from=builder /vinyldns/modules/api/target/universal/stage /opt/docker

# This will set the vinyldns version, make sure to have this in config... version = ${?VINYLDNS_VERSION}
ENV VINYLDNS_VERSION=$VINYLDNS_VERSION

RUN mkdir -p /opt/docker/lib_extra

# Mount the volume for config file and lib extras
# Note: These volume names are used in the build.sbt
VOLUME ["/opt/docker/lib_extra/", "/opt/docker/conf"]

EXPOSE 9000

ENTRYPOINT ["/opt/docker/bin/api"]
